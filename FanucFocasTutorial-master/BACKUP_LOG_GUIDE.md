# 백업 로그 가이드

## 로그 파일 위치

### 1. BackupLog.txt
- **위치**: `Backup\[IP]-[날짜]\BackupLog.txt`
- **용도**: 전체 백업 작업 로그
- **내용**: 모든 백업 항목의 성공/실패 요약

### 2. NCBackup_Debug.txt
- **위치**: 실행 파일 폴더\NCBackup_Debug.txt
- **용도**: NC 프로그램 백업 상세 디버그 로그
- **내용**: 각 프로그램별 시도, API 결과, 에러 코드

---

## BackupLog.txt 구조

### 헤더 정보
```
═══════════════════════════════════════════════════════
               FANUC CNC 백업 작업 로그
═══════════════════════════════════════════════════════
백업 시작 시간: 2026-01-12 09:42:22
IP 주소: 192.168.0.103
백업 폴더: E:\Release\net9.0-windows\win-x86\Backup\192.168.0.103-2026-01-12
═══════════════════════════════════════════════════════
```

### NC 프로그램 백업 로그
```
[09:42:22] NC 프로그램 백업 시작
  상태: 진행 중

[09:42:22] 프로그램 검색 중 (cnc_rdprogdir 사용)
  - 방식: cnc_rdprogdir API로 실제 존재하는 프로그램 목록 조회
  - cnc_rdprogdir 파라미터: type=0, start=1, end=9999, length=256
  - cnc_rdprogdir 결과: 2 (0=성공)
  - ✗ cnc_rdprogdir 실패 (에러 코드: 2)
  - 전체 범위 백업으로 전환 (O1~O9999)

  [O1] 백업 시작...
  [O1] cnc_upstart 호출 중 (프로그램 번호: 1)
  [O1] ✓ cnc_upstart 성공
  [O1] 업로드 중... (2474 bytes)
  [O1] ✓ 업로드 완료 (EW_RESET, 총 4013 bytes, 17회 읽기)
  [O1] cnc_upend 호출 완료
  [O1] ✓ 파일 저장 완료: ...\O1.nc (소요 시간: 0.26초)

  [O4] 백업 시작...
  [O4] cnc_upstart 호출 중 (프로그램 번호: 4)
  [O4] ✗ cnc_upstart 실패 (에러 코드: 5)  ← EW_DATA (프로그램 없음)
```

### 공구 옵셋 백업 로그
```
[10:00:00] 공구 옵셋 백업 시작
  - 백업 범위: T001~T200 (총 200개)
  - 진행 중... T050 (성공: 45, 실패: 5)
  - ✗ T010 읽기 실패: GetToolOffset failed
    스택 트레이스: at FanucFocasTutorial.CNCConnection.GetToolOffset(...)
  - ✓ 백업 완료: 성공 190개, 실패 10개
  - 파일 저장: ...\ToolOffset.ofs
  - 소요 시간: 2.34초
```

### 매크로 변수 백업 로그
```
[10:05:00] 매크로 변수 백업 시작
  - 백업 범위: #100~#999 (총 900개)
  - 진행 중... #100 (성공: 80, 실패: 20)
  - ✗ #105 cnc_rdmacro 실패 (에러 코드: 5)  ← EW_DATA
  - ✗ #120 예외 발생: Object reference not set...
  - 진행 중... #200 (성공: 180, 실패: 20)
  - ✓ 백업 완료: 성공 850개, 실패 50개
  - 소요 시간: 5.67초
```

### 파라미터 백업 로그
```
[10:10:00] 파라미터 백업 시작
  - 백업 범위: 파라미터 0~2000 (총 2001개)
  - 진행 중... 파라미터 0/2000 (성공: 0, 실패: 0)
  - ✗ 파라미터 15 cnc_rdparam 실패 (에러 코드: 6)  ← EW_NOOPT
  - ✗ 파라미터 25 예외 발생: Timeout...
  - 진행 중... 파라미터 200/2000 (성공: 190, 실패: 10)
  - ✓ 백업 완료: 성공 1950개, 실패 51개
  - 소요 시간: 12.45초
```

### 워크 좌표계 백업 로그
```
[10:15:00] 워크 좌표계 백업 시작
  - 백업 범위: G54~G59 (좌표계 1~6)
  - G54 cnc_rdzofs 호출 중 (coordNo=1, type=2, length=8)
  - G54 ✓ 읽기 성공 (에러 코드: 0)
  - G55 cnc_rdzofs 호출 중 (coordNo=2, type=2, length=8)
  - G55 ✗ 읽기 실패 (에러 코드: 5)  ← EW_DATA
  - ✓ 백업 완료: 성공 5개, 실패 1개
  - 소요 시간: 0.15초
```

### PMC/래더 백업 로그
```
[10:20:00] PMC/래더 백업 시작
  - PMC R 영역 백업 시작 (R0-R99)
    - R 영역 읽기 시작 (주소 0~99, 총 100개, type=5)
    - R 진행 중... 주소 50 (성공: 50, 실패: 0)
    - R 주소 70~79 읽기 실패 (에러 코드: 5)
  - PMC R 영역 완료: 성공 90개, 실패 10개
  - PMC G 영역 백업 시작 (G0-G99)
    - G 영역 읽기 시작 (주소 0~99, 총 100개, type=0)
  - PMC G 영역 완료: 성공 100개, 실패 0개
  - ✓ 전체 백업 완료: 성공 190개, 실패 10개
  - 소요 시간: 1.23초
```

---

## FOCAS 에러 코드 해석

### 주요 에러 코드
- **0 (EW_OK)**: 성공
- **2 (EW_LENGTH)**: 데이터 블록 길이 에러
- **5 (EW_DATA)**: 데이터 에러 (존재하지 않음)
- **6 (EW_NOOPT)**: 옵션 없음 (기능 미지원)
- **-1 (DNC_NORMAL)**: 정상 완료 (DNC)
- **-2 (EW_RESET)**: 업로드 완료 (일부 컨트롤러)

### NC 프로그램 백업 특수 케이스
```
cnc_upstart 결과: 0 (성공)
cnc_upload 결과: -2 (EW_RESET) → 정상 완료로 처리
```

---

## 디버그 시 확인 사항

### 1. 연결 문제
```
백업 시작 시간: ...
IP 주소: 192.168.0.103
백업 폴더: ...
✗ CNC 연결이 필요합니다.
```
→ 연결 상태 확인 필요

### 2. API 에러 (에러 코드 5)
```
[O4] ✗ cnc_upstart 실패 (에러 코드: 5)
✗ #105 cnc_rdmacro 실패 (에러 코드: 5)
✗ 파라미터 15 cnc_rdparam 실패 (에러 코드: 5)
```
→ **EW_DATA**: 해당 항목이 존재하지 않음 (정상)

### 3. API 에러 (에러 코드 6)
```
✗ 파라미터 1000 cnc_rdparam 실패 (에러 코드: 6)
```
→ **EW_NOOPT**: 해당 기능/옵션이 설비에 없음

### 4. 예외 발생
```
✗ T010 읽기 실패: GetToolOffset failed
  스택 트레이스: at FanucFocasTutorial.CNCConnection.GetToolOffset(...)
```
→ 코드 레벨 문제, 스택 트레이스로 위치 확인

### 5. 타임아웃
```
✗ 파라미터 25 예외 발생: Timeout...
```
→ 네트워크 지연 또는 설비 응답 없음

---

## 로그로 해결 가능한 문제

### ✓ NC 프로그램 백업 실패
**로그**:
```
[O100] cnc_upstart 호출 중 (프로그램 번호: 100)
[O100] ✗ cnc_upstart 실패 (에러 코드: 5)
```
**원인**: 프로그램 O100이 존재하지 않음
**해결**: 정상 (존재하지 않는 프로그램은 건너뜀)

### ✓ cnc_rdprogdir 실패
**로그**:
```
- cnc_rdprogdir 결과: 2 (0=성공)
- ✗ cnc_rdprogdir 실패 (에러 코드: 2)
- 전체 범위 백업으로 전환 (O1~O9999)
```
**원인**: API 파라미터 문제 (length 또는 type)
**해결**: 자동 폴백으로 1~9999 전체 검색

### ✓ 공구 옵셋 일부 실패
**로그**:
```
- ✗ T150 읽기 실패: GetToolOffset failed
- ✓ 백업 완료: 성공 190개, 실패 10개
```
**원인**: 일부 공구 데이터 읽기 실패
**해결**:
1. 스택 트레이스 확인
2. CNCConnection.GetToolOffset 메서드 검증
3. 해당 공구 번호 설비에서 수동 확인

### ✓ 전체 백업 실패
**로그**:
```
[10:00:00] ✗ NC 프로그램 백업 실패
  에러: CNC 연결이 필요합니다.
```
**원인**: 연결 끊김
**해결**: 설비 재연결 후 백업 재시도

---

## 로그 개선 이력

### v1.0 (2026-01-12)
- NC 프로그램: 매우 상세한 로그
- 다른 항목: 요약만 기록

### v2.0 (2026-01-12) - 개선
✓ **공구 옵셋**: 모든 실패 항목 로그 기록
✓ **매크로 변수**: API 에러 코드 추가 (처음 10개)
✓ **파라미터**: API 에러 코드 추가 (처음 10개)
✓ **스택 트레이스**: 예외 발생 위치 추적 가능

**개선 효과**:
- 에러 코드로 정확한 원인 파악 가능
- 실패한 항목 번호 추적 가능
- 디버그 시간 단축

---

## 추가 개선 제안

### 1. 에러 통계
```
백업 종료 시간: 2026-01-12 10:30:00
═══════════════════════════════════════════════════════
에러 통계:
- EW_DATA (5): 150건 (프로그램 없음)
- EW_NOOPT (6): 5건 (옵션 없음)
- 예외: 2건 (타임아웃)
═══════════════════════════════════════════════════════
```

### 2. 실패 항목 리스트
```
실패 항목:
- 프로그램: O4, O16, O17, ... (총 9766개)
- 공구: T150, T175 (총 10개)
- 매크로: #105, #120, ... (총 50개)
- 파라미터: 15, 25, ... (총 51개)
```

### 3. 성능 프로파일링
```
백업 소요 시간:
- NC 프로그램: 560.23초 (233개)
  - 평균: 2.4초/개
- 공구 옵셋: 2.34초 (200개)
  - 평균: 0.012초/개
- 매크로 변수: 5.67초 (900개)
  - 평균: 0.006초/개
- 파라미터: 12.45초 (2001개)
  - 평균: 0.006초/개
```

---

## 결론

**현재 로그로 디버그 가능 여부**: ✓ **가능**

**개선된 점**:
1. API 에러 코드 기록
2. 실패 항목 추적 가능
3. 스택 트레이스로 예외 위치 확인

**충분한 정보**:
- 어떤 백업 항목이 실패했는지
- 왜 실패했는지 (에러 코드)
- 어디서 실패했는지 (스택 트레이스)

추가로 더 자세한 로그가 필요하다면 위의 "추가 개선 제안" 참고
